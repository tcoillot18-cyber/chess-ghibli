<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>Chess Ghibli — Forêt Nuit</title>
    <style>
      :root { --square-size: calc(min(11vmin, 12vw, 7.6vh)); --board-radius: 16px; --grid-gap: 1px; }
      *{box-sizing:border-box} html,body{height:100%}
      body{margin:0;font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(100% 140% at 50% 0%,#0b1230 0%,#0a0f26 40%,#08102a 70%,#060c21 100%);color:#f3f4f6;overflow:hidden}
      .app{position:relative;display:grid;grid-template-rows:auto 1fr auto;gap:12px;height:100%;align-items:center;justify-items:center;padding:clamp(10px,2vmin,18px)}
      .header{position:relative;z-index:2;display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(10,17,40,.45);border:1px solid rgba(255,255,255,.06);border-radius:14px;backdrop-filter:blur(6px);max-width:96vw}
      .brand{font-weight:700;letter-spacing:.3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .controls{display:flex;gap:8px;z-index:2;flex-wrap:wrap}
      button{cursor:pointer;border:none;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.12);color:#fff;font-weight:600;letter-spacing:.3px}
      button:hover{background:rgba(255,255,255,.2)}
      .board-wrap{position:relative;z-index:1;padding:10px;border-radius:20px;background:radial-gradient(120% 140% at 50% 0%,rgba(90,120,100,.2),transparent 70%),linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.06);box-shadow:0 40px 80px rgba(0,0,0,.35),0 8px 18px rgba(0,0,0,.35) inset}
      .board{display:grid;grid-template-columns:repeat(8,var(--square-size));grid-template-rows:repeat(8,var(--square-size));gap:var(--grid-gap);background:linear-gradient(135deg,rgba(0,0,0,.25),rgba(255,255,255,.05));padding:var(--grid-gap);border-radius:var(--board-radius);position:relative;overflow:hidden;touch-action:manipulation}
      .board::after{content:"";position:absolute;inset:0;background-image:radial-gradient(rgba(0,0,0,.06) 1px,transparent 1px);background-size:6px 6px;mix-blend-mode:overlay;pointer-events:none}
      .square{width:var(--square-size);height:var(--square-size);display:grid;place-items:center;position:relative;border-radius:6px;overflow:hidden}
      .square.light{background:linear-gradient(180deg,#9b6847,#70462f)} .square.dark{background:linear-gradient(180deg,#3b2418,#2a1a12)}
      .square .hint{position:absolute;width:22%;height:22%;border-radius:999px;background:rgba(255,255,255,.75);box-shadow:0 0 0 6px rgba(255,255,255,.12) inset}
      .square.selected{outline:3px solid rgba(209,163,37,.85);z-index:2}
      .piece{width:78%;height:78%;user-select:none;touch-action:manipulation}
      .sky{position:fixed;inset:0;overflow:hidden;pointer-events:none}
      .stars{position:absolute;width:100%;height:100%}.star{position:absolute;width:2px;height:2px;background:#fff;border-radius:999px;opacity:.8;animation:twinkle 3.5s infinite ease-in-out}
      @keyframes twinkle{0%,100%{opacity:.25}50%{opacity:1}}
      .cloud{position:absolute;top:10%;width:40vw;height:16vw;background:radial-gradient(60% 80% at 50% 50%,rgba(255,255,255,.12),rgba(255,255,255,.02) 60%,transparent 70%);filter:blur(10px);border-radius:50%;animation:drift 140s linear infinite}
      .cloud.c2{top:25%;width:50vw;height:18vw;animation-duration:180s;animation-delay:-20s}
      .cloud.c3{top:40%;width:45vw;height:15vw;animation-duration:160s;animation-delay:-60s}
      .cloud.c4{top:55%;width:55vw;height:20vw;animation-duration:200s;animation-delay:-100s}
      @keyframes drift{from{transform:translateX(55vw)}to{transform:translateX(-120vw)}}
      .grass{position:fixed;left:0;right:0;bottom:-6vh;height:16vh;background:radial-gradient(80% 80% at 50% 0%,rgba(26,77,46,.55),rgba(26,77,46,.1) 60%,transparent 85%),linear-gradient(180deg,rgba(26,77,46,.65),rgba(6,20,16,0.0));filter:blur(.6px);pointer-events:none}
      .footer{position:relative;z-index:2;opacity:.9;font-size:12px;text-align:center;padding:2px 8px}
    </style>

    <script>
      /* ---- Offline-lite chess engine (basic legal moves + captures + promotion) ---- */
      (function(w){
        function idx(sq){ var f=sq.charCodeAt(0)-97, r=sq.charCodeAt(1)-49; return {f,r}; }
        function inb(f,r){ return f>=0&&f<8&&r>=0&&r<8; }
        function startBoard(){
          var e=null,W='w',B='b';
          var P=(c)=>({type:'p',color:c}), R=(c)=>({type:'r',color:c}), N=(c)=>({type:'n',color:c}), Bf=(c)=>({type:'b',color:c}), Q=(c)=>({type:'q',color:c}), K=(c)=>({type:'k',color:c});
          return [
            [R(W),N(W),Bf(W),Q(W),K(W),Bf(W),N(W),R(W)],
            [P(W),P(W),P(W),P(W),P(W),P(W),P(W),P(W)],
            [e,e,e,e,e,e,e,e],
            [e,e,e,e,e,e,e,e],
            [e,e,e,e,e,e,e,e],
            [e,e,e,e,e,e,e,e],
            [P(B),P(B),P(B),P(B),P(B),P(B),P(B),P(B)],
            [R(B),N(B),Bf(B),Q(B),K(B),Bf(B),N(B),R(B)]
          ];
        }
        function sqOf(f,r){ return String.fromCharCode(97+f)+String.fromCharCode(49+r); }
        function pieceAt(b,sq){ var p=idx(sq); return b[7-p.r][p.f]; }
        function setAt(b,sq,val){ var p=idx(sq); b[7-p.r][p.f]=val; }
        function genMoves(b,turn,sq){
          var p=pieceAt(b,sq); if(!p || p.color!==turn) return [];
          var res=[], f=idx(sq).f, r=idx(sq).r, dr,df,nf,nr,t,target;
          function add(to){ var tpiece=pieceAt(b,to); res.push({from:sq,to:to,captured:tpiece?tpiece.type:undefined,piece:p.type}); }
          if(p.type==='p'){
            var dir = (p.color==='w')?+1:-1;
            var startRank = (p.color==='w')?1:6;
            var nf=f, nr=r+dir, t=sqOf(nf,nr);
            if(inb(nf,nr) && !pieceAt(b,t)){ res.push({from:sq,to:t,piece:p.type});
              if(r===startRank){ nr=r+2*dir; t=sqOf(nf,nr); if(!pieceAt(b,t)) res.push({from:sq,to:t,piece:p.type}); }
            }
            for(df of [-1,1]){
              nf=f+df; nr=r+dir;
              if(inb(nf,nr)){ t=sqOf(nf,nr); target=pieceAt(b,t); if(target && target.color!==p.color) add(t); }
            }
          } else if(p.type==='n'){
            var jumps=[[1,2],[2,1],[2,-1],[1,-2],[-1,-2],[-2,-1],[-2,1],[-1,2]];
            for(var k=0;k<jumps.length;k++){ nf=f+jumps[k][0]; nr=r+jumps[k][1];
              if(!inb(nf,nr)) continue; t=sqOf(nf,nr); target=pieceAt(b,t);
              if(!target || target.color!==p.color) add(t);
            }
          } else if(p.type==='k'){
            for(df=-1;df<=1;df++){ for(dr=-1;dr<=1;dr++){
              if(df===0 && dr===0) continue; nf=f+df; nr=r+dr;
              if(!inb(nf,nr)) continue; t=sqOf(nf,nr); target=pieceAt(b,t);
              if(!target || target.color!==p.color) add(t);
            }}
          } else {
            var dirs=[];
            if(p.type==='b'||p.type==='q') dirs.push([1,1],[1,-1],[-1,1],[-1,-1]);
            if(p.type==='r'||p.type==='q') dirs.push([1,0],[-1,0],[0,1],[0,-1]);
            for(var d=0;d<dirs.length;d++){
              df=dirs[d][0]; dr=dirs[d][1]; nf=f+df; nr=r+dr;
              while(inb(nf,nr)){
                t=sqOf(nf,nr); target=pieceAt(b,t);
                if(!target){ add(t); } else { if(target.color!==p.color) add(t); break; }
                nf+=df; nr+=dr;
              }
            }
          }
          return res;
        }
        function Board(){
          var b=startBoard(), turn='w';
          return {
            board: function(){ return b.map(row=>row.map(p=>p?{type:p.type,color:p.color}:null)); },
            reset: function(){ b=startBoard(); turn='w'; },
            turn: function(){ return turn; },
            get: function(sq){ return pieceAt(b,sq); },
            moves: function(opts){ var sq=opts && opts.square; if(!sq) return []; return genMoves(b,turn,sq).map(m=>({from:m.from,to:m.to,verbose:true})); },
            move: function(m){
              var legal = genMoves(b,turn,m.from).find(x=>x.to===m.to);
              if(!legal) return null;
              var P = pieceAt(b,m.from);
              var to = m.to;
              var r = idx(to).r;
              if(P.type==='p' && ((P.color==='w' && r===7) || (P.color==='b' && r===0))){
                setAt(b,m.from,null); setAt(b,to,{type:(m.promotion||'q'),color:P.color}); turn = (turn==='w')?'b':'w'; return {flags:'p'};
              }
              setAt(b,m.from,null); setAt(b,to,P); turn = (turn==='w')?'b':'w'; return {};
            }
          };
        }
        w.Chess = Board;
      })(window);
    </script>

    <script>
      /* ---- SVG pièces, style forêt/ghibli ---- */
      (function(){
        function wrap(g){ return '<svg viewBox="0 0 100 100" class="piece" xmlns="http://www.w3.org/2000/svg">'+g+'</svg>'; }
        window.pieceSVG = function(code){
          if (!code) return "";
          const side = code[0] === 'w' ? 'w' : 'b';
          const type = code[1].toLowerCase();
          const fill = side === 'w' ? '#f4e3c1' : '#3b2b1c';
          const stroke = '#1c120c';
          const crown = '#d1a325';
          if (type === 'k') return wrap('<g stroke=\"'+stroke+'\" stroke-width=\"2\"><polygon points=\"40,18 50,8 60,18 70,10 72,26 28,26 30,10\" fill=\"'+crown+'\" /><circle cx=\"50\" cy=\"50\" r=\"24\" fill=\"'+fill+'\" /></g>');
          if (type === 'q') return wrap('<g stroke=\"'+stroke+'\" stroke-width=\"2\"><polygon points=\"30,18 40,8 50,18 60,8 70,18 74,28 26,28\" fill=\"'+crown+'\" /><ellipse cx=\"50\" cy=\"58\" rx=\"26\" ry=\"22\" fill=\"'+fill+'\" /></g>');
          if (type === 'r') return wrap('<g stroke=\"'+stroke+'\" stroke-width=\"2\"><rect x=\"44\" y=\"50\" width=\"12\" height=\"26\" fill=\"#5b3a2a\" rx=\"3\" /><circle cx=\"50\" cy=\"40\" r=\"22\" fill=\"#2f6b3f\" /></g>');
          if (type === 'b') return wrap('<g stroke=\"'+stroke+'\" stroke-width=\"2\"><ellipse cx=\"50\" cy=\"60\" rx=\"20\" ry=\"22\" fill=\"'+fill+'\" /><path d=\"M30 34 C42 18, 58 18, 70 34 L60 38 C52 30, 48 30, 40 38 Z\" fill=\"#b43b6a\" /></g>');
          if (type === 'n') return wrap('<g stroke=\"'+stroke+'\" stroke-width=\"2\"><path d=\"M30 56 C30 40, 44 34, 56 36 C66 38, 72 44, 72 56 C72 70, 62 78, 48 80 C36 82, 30 74, 30 66 Z\" fill=\"'+fill+'\" /></g>');
          if (type === 'p') return wrap('<g stroke=\"'+stroke+'\" stroke-width=\"2\"><circle cx=\"50\" cy=\"40\" r=\"20\" fill=\"'+fill+'\" /></g>');
          return "";
        };
      })();
    </script>
  </head>
  <body>
    <div class="app">
      <header class="header">
        <span class="brand">♟️ Chess Ghibli — Forêt Nuit</span>
        <div class="controls">
          <button id="btnNew" aria-label="Rejouer">Rejouer</button>
          <button id="btnFlip" aria-label="Inverser l'échiquier">Flip</button>
        </div>
      </header>
      <main class="board-wrap">
        <div id="board" class="board" aria-label="Échiquier"></div>
      </main>
      <div class="grass"></div>
      <footer class="footer">
        DA style Ghibli • tons terre & forêt • étoiles scintillantes • nuages droite→gauche
      </footer>
      <div class="sky" aria-hidden="true">
        <div class="stars" id="stars"></div>
        <div class="cloud c1"></div>
        <div class="cloud c2"></div>
        <div class="cloud c3"></div>
        <div class="cloud c4"></div>
      </div>
    </div>

    <script>
      (function(){
        const files = ['a','b','c','d','e','f','g','h'];
        const ranks = ['1','2','3','4','5','6','7','8'];
        let orientation = 'white';
        const game = new window.Chess();

        const boardEl = document.getElementById('board');
        const btnNew = document.getElementById('btnNew');
        const btnFlip = document.getElementById('btnFlip');
        const starsEl = document.getElementById('stars');

        // Stars
        (function makeStars(){
          let seed = 12345;
          const rnd = () => (seed = (seed * 16807) % 2147483647) / 2147483647;
          for (let i=0;i<120;i++){
            const d = document.createElement('div');
            d.className = 'star';
            d.style.left = (rnd()*100).toFixed(2) + '%';
            d.style.top = (rnd()*70).toFixed(2) + '%';
            d.style.animationDelay = (rnd()*4).toFixed(2) + 's';
            const size = 1 + Math.round(rnd()*1.5);
            d.style.width = size + 'px';
            d.style.height = size + 'px';
            starsEl.appendChild(d);
          }
        })();

        function makeSquares() {
          const list = [];
          for (let r=7; r>=0; r--) for (let f=0; f<8; f++) list.push(files[f]+ranks[r]);
          return orientation === 'black' ? list.reverse() : list;
        }

        function render() {
          boardEl.innerHTML = '';
          const squares = makeSquares();
          const state = game.board();
          squares.forEach((sq, idx) => {
            const el = document.createElement('div');
            el.className = 'square ' + (((Math.floor(idx/8)+idx)%2===0) ? 'light':'dark');
            el.setAttribute('data-square', sq);
            el.setAttribute('role', 'button');
            el.setAttribute('aria-label', sq);

            const f = files.indexOf(sq[0]);
            const r = ranks.indexOf(sq[1]);
            const p = state[7-r]?.[f] || null;
            if (p) {
              const map = {k:'K',q:'Q',r:'R',b:'B',n:'N',p:'P'};
              const code = (p.color === 'w' ? 'w':'b') + map[p.type].toUpperCase();
              el.innerHTML = window.pieceSVG(code);
            }
            el.addEventListener('click', onSquareClick, {passive:true});
            boardEl.appendChild(el);
          });
        }

        let selected = null;
        let legalMoves = [];

        function clearHighlights() {
          document.querySelectorAll('.square').forEach(s=>s.classList.remove('selected'));
          document.querySelectorAll('.square .hint').forEach(h=>h.remove());
        }

        function showHints() {
          legalMoves.forEach(m => {
            const toEl = document.querySelector('.square[data-square="'+m.to+'"]');
            if (toEl) {
              const dot = document.createElement('div');
              dot.className = 'hint';
              toEl.appendChild(dot);
            }
          });
        }

        function onSquareClick(e) {
          const sq = e.currentTarget.getAttribute('data-square');
          const piece = game.get(sq);
          const isOwn = piece && piece.color === game.turn();

          if (selected) {
            const legal = legalMoves.find(m => m.to === sq);
            if (legal) {
              game.move({ from: selected, to: sq, promotion: 'q' });
              selected = null;
              legalMoves = [];
              clearHighlights();
              render();
              return;
            }
            if (isOwn) {
              selected = sq;
              legalMoves = game.moves({ square: sq, verbose: true });
              clearHighlights();
              document.querySelector('.square[data-square="'+sq+'"]')?.classList.add('selected');
              showHints();
            } else {
              selected = null;
              legalMoves = [];
              clearHighlights();
            }
            return;
          }

          if (isOwn) {
            selected = sq;
            legalMoves = game.moves({ square: sq, verbose: true });
            clearHighlights();
            document.querySelector('.square[data-square="'+sq+'"]')?.classList.add('selected');
            showHints();
          }
        }

        btnNew.addEventListener('click', () => {
          game.reset(); selected = null; legalMoves = []; clearHighlights(); render();
        });
        btnFlip.addEventListener('click', () => {
          orientation = (orientation === 'white') ? 'black' : 'white';
          selected = null; legalMoves = []; clearHighlights(); render();
        });

        render();
      })();
    </script>
  </body>
</html>
