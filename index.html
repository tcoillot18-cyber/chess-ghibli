<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>Chess Ghibli — Sol de forêt + grille 8×8 (Click ou Drag)</title>
    <style>
      :root{
        --sq: min(11vmin, 12vw, 8vh);
        --grid-line: rgba(255,255,255,.18);
        --grid-shadow: rgba(0,0,0,.12);
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        background:radial-gradient(110% 150% at 50% 0%,#0b1230 0%,#0a0f26 40%,#08102a 70%,#060c21 100%);
        color:#f3f4f6;
        overflow:hidden;
        touch-action:manipulation;
      }
      .app{
        height:100%;display:grid;grid-template-rows:auto 1fr auto;gap:12px;
        align-items:center;justify-items:center;padding:clamp(10px,2vmin,18px);
      }
      header{
        display:flex;align-items:center;gap:10px;padding:8px 12px;
        background:rgba(10,17,40,.45);border:1px solid rgba(255,255,255,.06);
        border-radius:14px;backdrop-filter:blur(6px);
        flex-wrap:wrap
      }
      button{cursor:pointer;border:none;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.12);color:#fff;font-weight:600}
      button:hover{background:rgba(255,255,255,.2)}
      .toggle{display:inline-flex;gap:6px;align-items:center;background:rgba(255,255,255,.08);padding:6px;border-radius:12px}
      .toggle button{padding:8px 10px;border-radius:10px;background:transparent;opacity:.65}
      .toggle button.active{background:rgba(255,255,255,.18);opacity:1}

      .wrap{
        position:relative;display:grid;place-items:center;
        padding:12px;border-radius:22px;
        background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
        border:1px solid rgba(255,255,255,.06);
        box-shadow:0 40px 80px rgba(0,0,0,.35),0 8px 18px rgba(0,0,0,.35) inset;
      }

      .stage{
        position:relative;
        width: calc(var(--sq) * 8);
        height: calc(var(--sq) * 8);
        border-radius:18px;
        overflow:hidden;
        isolation:isolate;
        touch-action:none;
      }
      .bg{
        position:absolute;inset:0;
        background-image:url('assets/forest/forest-background-light.webp');
        background-size:cover;background-position:center;background-repeat:no-repeat;
        filter:saturate(1.02) brightness(1.00);
        z-index:0;
      }
      .grid{
        position:absolute;inset:0;z-index:1;pointer-events:none;
        background:
          linear-gradient(to right, var(--grid-line) 1px, transparent 1px) 0 0/ calc(100%/8) 100%,
          linear-gradient(to bottom, var(--grid-line) 1px, transparent 1px) 0 0/ 100% calc(100%/8),
          linear-gradient(to right, var(--grid-shadow) 1px, transparent 1px) 0 0/ calc(100%/8) 100%,
          linear-gradient(to bottom, var(--grid-shadow) 1px, transparent 1px) 0 0/ 100% calc(100%/8);
        mix-blend-mode:soft-light;
      }
      .mask{
        position:absolute;inset:0;z-index:2;pointer-events:none;
        display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);
      }
      .sq{opacity:.10}
      .sq.light{background:radial-gradient(160% 160% at 50% 50%, rgba(255,255,255,.60) 0%, rgba(255,255,255,0) 70%);}
      .sq.dark{ background:radial-gradient(160% 160% at 50% 50%, rgba(0,0,0,.55)   0%, rgba(0,0,0,0)   70%);}

      .board{
        position:absolute;inset:0;z-index:3;
        display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);
      }
      .cell{position:relative;display:grid;place-items:center}
      .piece{width:88%;height:88%;object-fit:contain;filter:drop-shadow(0 2px 0 rgba(0,0,0,.25)) drop-shadow(0 8px 12px rgba(0,0,0,.18)); touch-action:none;}
      .hint{position:absolute;width:20%;height:20%;border-radius:999px;background:rgba(255,255,255,.95);box-shadow:0 0 0 6px rgba(0,0,0,.14) inset}
      .selected{outline:3px solid #d1a325;border-radius:10px}
      .dragGhost{position:fixed;left:0;top:0;width:min(12vmin,80px);height:min(12vmin,80px);pointer-events:none;z-index:9999;transform:translate(-50%,-50%);filter:drop-shadow(0 8px 16px rgba(0,0,0,.35))}
      footer{opacity:.85;font-size:12px}
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <span>♟️ Chess Ghibli — Sol de forêt + grille 8×8</span>
        <button id="btnNew">Rejouer</button>
        <button id="btnFlip">Flip</button>
        <div class="toggle" role="tablist" aria-label="Mode d'interaction">
          <button id="modeClick" class="active" aria-selected="true">Cliquer</button>
          <button id="modeDrag">Drag & Drop</button>
        </div>
      </header>

      <div class="wrap">
        <div class="stage" id="stage">
          <div class="bg"></div>
          <div class="grid" aria-hidden="true"></div>
          <div class="mask" id="mask" aria-hidden="true"></div>
          <div class="board" id="board"></div>
        </div>
      </div>

      <footer>Choisis ton interaction : <b>Cliquer</b> (sélection + destination) ou <b>Drag & Drop</b> (glisser/déposer). Mobile & desktop.</footer>
    </div>

    <script>
      (function(w){
        function idx(sq){ var f=sq.charCodeAt(0)-97, r=sq.charCodeAt(1)-49; return {f,r}; }
        function inb(f,r){ return f>=0&&f<8&&r>=0&&r<8; }
        function startBoard(){
          var e=null,W='w',B='b';
          var P=(c)=>({type:'p',color:c}), R=(c)=>({type:'r',color:c}), N=(c)=>({type:'n',color:c}), Bf=(c)=>({type:'b',color:c}), Q=(c)=>({type:'q'), K=(c)=>({type:'k',color:c});
          return [
            [R(B),N(B),Bf(B),Q(B),K(B),Bf(B),N(B),R(B)],
            [P(B),P(B),P(B),P(B),P(B),P(B),P(B),P(B)],
            [e,e,e,e,e,e,e,e],
            [e,e,e,e,e,e,e,e],
            [e,e,e,e,e,e,e,e],
            [e,e,e,e,e,e,e,e],
            [P(W),P(W),P(W),P(W),P(W),P(W),P(W),P(W)],
            [R(W),N(W),Bf(W),Q(W),K(W),Bf(W),N(W),R(W)]
          ];
        }
        function sqOf(f,r){ return String.fromCharCode(97+f)+String.fromCharCode(49+r); }
        function pieceAt(b,sq){ var p=idx(sq); return b[7-p.r][p.f]; }
        function setAt(b,sq,val){ var p=idx(sq); b[7-p.r][p.f]=val; }
        function genMoves(b,turn,sq){
          var p=pieceAt(b,sq); if(!p || p.color!==turn) return [];
          var res=[], f=idx(sq).f, r=idx(sq).r, dr,df,nf,nr,t,target;
          function add(to){ var tpiece=pieceAt(b,to); res.push({from:sq,to:to,captured:tpiece?tpiece.type:undefined,piece:p.type}); }
          if(p.type==='p'){
            var dir = (p.color==='w')?+1:-1;
            var startRank = (p.color==='w')?1:6;
            var nf=f, nr=r+dir, t=sqOf(nf,nr);
            if(inb(nf,nr) && !pieceAt(b,t)){ res.push({from:sq,to:t,piece:p.type});
              if(r===startRank){ nr=r+2*dir; t=sqOf(nf,nr); if(!pieceAt(b,t)) res.push({from:sq,to:t,piece:p.type}); } }
            for(df of [-1,1]){ nf=f+df; nr=r+dir; if(inb(nf,nr)){ t=sqOf(nf,nr); target=pieceAt(b,t); if(target && target.color!==p.color) add(t); } }
          } else if(p.type==='n'){
            var jumps=[[1,2],[2,1],[2,-1],[1,-2],[-1,-2],[-2,-1],[-2,1],[-1,2]];
            for(var k=0;k<jumps.length;k++){ nf=f+jumps[k][0]; nr=r+jumps[k][1];
              if(!inb(nf,nr)) continue; t=sqOf(nf,nr); target=pieceAt(b,t);
              if(!target || target.color!==p.color) add(t);
            }
          } else if(p.type==='k'){
            for(df=-1;df<=1;df++){ for(dr=-1;dr<=1;dr++){
              if(df===0 && dr===0) continue; nf=f+df; nr=r+dr;
              if(!inb(nf,nr)) continue; t=sqOf(nf,nr); target=pieceAt(b,t);
              if(!target || target.color!==p.color) add(t);
            }}
          } else {
            var dirs=[];
            if(p.type==='b'||p.type==='q') dirs.push([1,1],[1,-1],[-1,1],[-1,-1]);
            if(p.type==='r'||p.type==='q') dirs.push([1,0],[-1,0],[0,1],[0,-1]);
            for(var d=0;d<dirs.length;d++){
              df=dirs[d][0]; dr=dirs[d][1]; nf=f+df; nr=r+dr;
              while(inb(nf,nr)){
                t=sqOf(nf,nr); target=pieceAt(b,t);
                if(!target){ add(t); } else { if(target.color!==p.color) add(t); break; }
                nf+=df; nr+=dr;
              }
            }
          }
          return res;
        }
        function Board(){
          var b=startBoard(), turn='w';
          return {
            board: function(){ return b.map(row=>row.map(p=>p?{type:p.type,color:p.color}:null)); },
            reset: function(){ b=startBoard(); turn='w'; },
            turn: function(){ return turn; },
            get: function(sq){ return pieceAt(b,sq); },
            moves: function(opts){ var sq=opts && opts.square; if(!sq) return []; return genMoves(b,turn,sq).map(m=>({from:m.from,to:m.to,verbose:true})); },
            move: function(m){
              var legal = genMoves(b,turn,m.from).find(x=>x.to===m.to);
              if(!legal) return null;
              var P = pieceAt(b,m.from);
              var to = m.to;
              var r = idx(to).r;
              if(P.type==='p' && ((P.color==='w' && r===7) || (P.color==='b' && r===0))){
                setAt(b,m.from,null); setAt(b,to,{type:(m.promotion||'q'),color:P.color}); turn = (turn==='w')?'b':'w'; return {flags:'p'};
              }
              setAt(b,m.from,null); setAt(b,to,P); turn = (turn==='w')?'b':'w'; return {};
            }
          };
        }
        w.Chess = Board;
      })(window);

      (function(){
        const files = ['a','b','c','d','e','f','g','h'];
        const ranks = ['1','2','3','4','5','6','7','8'];
        let orientation = 'white';
        const game = new window.Chess();

        const boardEl = document.getElementById('board');
        const mask = document.getElementById('mask');
        const btnNew = document.getElementById('btnNew');
        const btnFlip = document.getElementById('btnFlip');
        const modeClickBtn = document.getElementById('modeClick');
        const modeDragBtn  = document.getElementById('modeDrag');

        let interactionMode = 'click'; // 'click' or 'drag'

        const mapFile = { k:'king-cat.webp', q:'queen-frog.webp', b:'bishop-owl.webp', n:'knight-fox.webp', r:'rook-bear.webp', p:'pawn-mouse.webp' };
        function assetPath(color, type){
          const side = (color === 'w') ? 'white' : 'black';
          return `assets/pieces/${side}/${mapFile[type]}`;
        }
        function isLightSquare(sq){
          const f = sq.charCodeAt(0) - 97;
          const r = sq.charCodeAt(1) - 49;
          return ((f + r) % 2) === 1;
        }
        function renderMask(){
          mask.innerHTML = '';
          const squares = [];
          for (let r=7; r>=0; r--) for (let f=0; f<8; f++) squares.push(files[f]+ranks[r]);
          const order = (orientation === 'black') ? squares.slice().reverse() : squares;
          order.forEach(sq => {
            const d = document.createElement('div');
            d.className = 'sq ' + (isLightSquare(sq) ? 'light' : 'dark');
            mask.appendChild(d);
          });
        }
        function squareList(){
          const list = [];
          for (let r=7; r>=0; r--) for (let f=0; f<8; f++) list.push(files[f]+ranks[r]);
          return (orientation === 'black') ? list.reverse() : list;
        }
        function pieceAtSquareFromState(state, sq){
          const f = files.indexOf(sq[0]);
          const r = ranks.indexOf(sq[1]);
          return state[7-r]?.[f] || null;
        }

        function render(){
          boardEl.innerHTML = '';
          const order = squareList();
          const state = game.board();
          order.forEach((sq) => {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.setAttribute('data-square', sq);

            const p = pieceAtSquareFromState(state, sq);
            if (p) {
              const img = new Image();
              img.className = 'piece';
              img.alt = (p.color==='w'?'White ':'Black ') + p.type;
              img.src = assetPath(p.color, p.type);
              img.setAttribute('data-square', sq);
              cell.appendChild(img);

              if (interactionMode === 'drag') {
                img.style.cursor = 'grab';
                img.addEventListener('pointerdown', (ev)=>onDragStart(ev, sq), {passive:false});
              } else {
                img.style.cursor = 'pointer';
              }
            }
            if (interactionMode === 'click') {
              cell.addEventListener('click', onCellClick, {passive:true});
            }
            boardEl.appendChild(cell);
          });
          renderMask();
        }

        // ---------- CLICK-TO-MOVE ----------
        let selected = null;
        let legalMoves = [];
        function clearHighlights() {
          document.querySelectorAll('.cell').forEach(s=>s.classList.remove('selected'));
          document.querySelectorAll('.cell .hint').forEach(h=>h.remove());
        }
        function showHints() {
          legalMoves.forEach(m => {
            const toEl = document.querySelector('.cell[data-square="'+m.to+'"]');
            if (toEl) {
              const dot = document.createElement('div');
              dot.className = 'hint';
              toEl.appendChild(dot);
            }
          });
        }
        function onCellClick(e) {
          const sq = e.currentTarget.getAttribute('data-square');
          const piece = game.get(sq);
          const isOwn = piece && piece.color === game.turn();

          if (selected) {
            const legal = legalMoves.find(m => m.to === sq);
            if (legal) {
              game.move({ from: selected, to: sq, promotion: 'q' });
              selected = null; legalMoves = []; clearHighlights(); render(); return;
            }
            if (isOwn) {
              selected = sq;
              legalMoves = game.moves({ square: sq, verbose: true });
              clearHighlights(); document.querySelector('.cell[data-square="'+sq+'"]')?.classList.add('selected'); showHints();
            } else { selected = null; legalMoves = []; clearHighlights(); }
            return;
          }
          if (isOwn) {
            selected = sq;
            legalMoves = game.moves({ square: sq, verbose: true });
            clearHighlights(); document.querySelector('.cell[data-square="'+sq+'"]')?.classList.add('selected'); showHints();
          }
        }

        // ---------- DRAG & DROP ----------
        let drag = { active:false, from:null, ghost:null, moves:[] };
        function onDragStart(ev, sq){
          ev.preventDefault();
          const piece = game.get(sq);
          if (!piece || piece.color !== game.turn()) return;

          drag.active = true;
          drag.from = sq;
          drag.moves = game.moves({ square: sq, verbose: true });

          // show hints
          clearHighlights();
          const fromEl = document.querySelector('.cell[data-square="'+sq+'"]');
          if (fromEl) fromEl.classList.add('selected');
          showHintsCustom(drag.moves);

          // ghost
          const img = ev.currentTarget;
          const g = img.cloneNode(true);
          g.classList.add('dragGhost');
          document.body.appendChild(g);
          drag.ghost = g;

          moveGhost(ev.clientX, ev.clientY);
          img.setPointerCapture?.(ev.pointerId);
          window.addEventListener('pointermove', onDragMove, {passive:false});
          window.addEventListener('pointerup', onDragEnd, {passive:false});
        }
        function moveGhost(x,y){
          if (!drag.ghost) return;
          drag.ghost.style.left = x+'px';
          drag.ghost.style.top  = y+'px';
        }
        function onDragMove(ev){
          ev.preventDefault();
          moveGhost(ev.clientX, ev.clientY);
        }
        function onDragEnd(ev){
          ev.preventDefault();
          window.removeEventListener('pointermove', onDragMove);
          window.removeEventListener('pointerup', onDragEnd);
          if (!drag.active) return;

          const el = document.elementFromPoint(ev.clientX, ev.clientY);
          const cell = el && el.closest ? el.closest('.cell') : null;
          const to = cell ? cell.getAttribute('data-square') : null;
          const legal = drag.moves.find(m => m.to === to);
          if (legal) {
            game.move({ from: drag.from, to: to, promotion: 'q' });
          }

          // cleanup
          drag.active = false;
          drag.from = null;
          drag.moves = [];
          if (drag.ghost && drag.ghost.parentNode) drag.ghost.parentNode.removeChild(drag.ghost);
          drag.ghost = null;
          clearHighlights();
          render();
        }
        function showHintsCustom(moves){
          moves.forEach(m => {
            const toEl = document.querySelector('.cell[data-square="'+m.to+'"]');
            if (toEl) {
              const dot = document.createElement('div');
              dot.className = 'hint';
              toEl.appendChild(dot);
            }
          });
        }

        // ---------- Controls ----------
        btnNew.addEventListener('click', () => { game.reset(); selected=null; legalMoves=[]; clearHighlights(); render(); });
        btnFlip.addEventListener('click', () => { orientation = (orientation === 'white') ? 'black' : 'white'; selected=null; legalMoves=[]; clearHighlights(); render(); });

        modeClickBtn.addEventListener('click', () => {
          interactionMode = 'click';
          modeClickBtn.classList.add('active');
          modeDragBtn.classList.remove('active');
          render();
        });
        modeDragBtn.addEventListener('click', () => {
          interactionMode = 'drag';
          modeDragBtn.classList.add('active');
          modeClickBtn.classList.remove('active');
          render();
        });

        render();
      })();
    </script>
  </body>
</html>
